<!DOCTYPE html>
<html lang="zh-cn">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>AI 助手</title>
  <link rel="stylesheet" href="/css/navbar.css" />
  <style>
    body { margin: 0; font-family: Arial, sans-serif; }
    .container { padding-top: 56px; max-width: 960px; margin: 0 auto; }
    .chat-box { height: calc(100vh - 200px); overflow-y: auto; padding: 16px; background: #fafafa; border: 1px solid #eee; border-radius: 8px; }
    .msg { margin: 10px 0; display: flex; }
    .msg.user { justify-content: flex-end; }
    .msg .bubble { max-width: 72%; padding: 10px 12px; border-radius: 10px; line-height: 1.5; }
    .msg.user .bubble { background: #0984e3; color: #fff; border-bottom-right-radius: 2px; }
    .msg.ai .bubble { background: #fff; border: 1px solid #eee; border-bottom-left-radius: 2px; }
    .bubble pre, .bubble code { background:#f6f8fa; padding:2px 4px; border-radius:4px; font-family: Consolas, monospace; }
    .bubble pre { padding:10px; overflow:auto; }
    .bubble table { border-collapse: collapse; width:100%; margin:8px 0; font-size:14px; }
    .bubble th, .bubble td { border:1px solid #ddd; padding:6px 8px; text-align:left; vertical-align:top; }
    .bubble th { background:#f0f2f5; font-weight:600; }
    .bubble tr:nth-child(even) td { background:#fcfcfc; }
    .input-row { margin-top: 12px; display: flex; gap: 8px; }
    .input-row input { flex: 1; padding: 10px 12px; border: 1px solid #ddd; border-radius: 6px; }
    .input-row button { padding: 10px 16px; background: #0984e3; color: #fff; border: none; border-radius: 6px; cursor: pointer; }
    .hint { color: #888; font-size: 12px; margin-top: 6px; }
  </style>
  <script src="https://cdn.jsdelivr.net/npm/marked@11.1.1/marked.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/dompurify@3.1.6/dist/purify.min.js"></script>
  <script>
    // 配置 Marked 支持 GFM（含表格）
    marked.setOptions({ gfm: true, breaks: true });
    let sessionId = '';
    let renderTimer = null;

    function appendMsg(role, text) {
      const box = document.getElementById('chatBox');
      const div = document.createElement('div');
      div.className = 'msg ' + role;
      const b = document.createElement('div');
      b.className = 'bubble';
      b.textContent = text;
      div.appendChild(b);
      box.appendChild(div);
      box.scrollTop = box.scrollHeight;
    }

    async function sendMsg() {
      const input = document.getElementById('msgInput');
      const val = input.value.trim();
      if (!val) return;
      appendMsg('user', val);
      input.value = '';
      try {
        // 使用流式 SSE
        const resp = await fetch('/ai/chat/stream', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ sessionId, message: val })
        });
        if (!resp.ok || !resp.body) {
          appendMsg('ai', '错误：无法建立流');
          return;
        }
        let aiAccum = '';
        let aiBubbleDiv = null;
        const box = document.getElementById('chatBox');
        const reader = resp.body.getReader();
        const decoder = new TextDecoder('utf-8');
        function ensureBubble() {
          if (!aiBubbleDiv) {
            const wrap = document.createElement('div');
            wrap.className = 'msg ai';
            aiBubbleDiv = document.createElement('div');
            aiBubbleDiv.className = 'bubble';
            aiBubbleDiv.textContent = '';
            wrap.appendChild(aiBubbleDiv);
            box.appendChild(wrap);
          }
        }
        (async () => {
          while (true) {
            const { done, value } = await reader.read();
            if (done) break;
            const chunk = decoder.decode(value, { stream: true });
            // 解析 SSE: 多行 data:xxx
            const lines = chunk.split(/\r?\n/).filter(l => l.startsWith('data:'));
            for (const line of lines) {
              const payload = line.substring(5).trim();
              if (!payload) continue;
              // 事件分类（简单约定）
              try {
                // session/done/error/token 全部统一当作文本追加（session 用于更新 sessionId）
                if (payload.startsWith('{') && payload.endsWith('}')) {
                  // 如果未来发送 JSON，可在此解析
                }
                if (payload.startsWith('error:')) {
                  ensureBubble();
                  aiBubbleDiv.textContent = aiAccum + '\n[错误] ' + payload.slice(6);
                  continue;
                }
                if (payload.startsWith('session:')) {
                  sessionId = payload.slice(8);
                  continue;
                }
                if (payload.startsWith('done:')) {
                  const finalText = payload.slice(5);
                  aiAccum = finalText || aiAccum;
                  ensureBubble();
                  flushMarkdown(aiBubbleDiv, aiAccum, true);
                  box.scrollTop = box.scrollHeight;
                  continue;
                }
                // token: 累积并节流渲染
                ensureBubble();
                aiAccum += payload;
                scheduleMarkdown(aiBubbleDiv, aiAccum);
                box.scrollTop = box.scrollHeight;
              } catch (e) {
                // 忽略单个 token 错误
              }
            }
          }
        })();
      } catch (e) {
        appendMsg('ai', '网络或服务异常');
      }
    }

    function scheduleMarkdown(target, text) {
      if (renderTimer) return; // 已有计划
      renderTimer = setTimeout(() => {
        flushMarkdown(target, text, false);
      }, 80); // 80ms 批处理一波，减少频繁解析
    }

    function flushMarkdown(target, text, force) {
      if (renderTimer) {
        clearTimeout(renderTimer);
        renderTimer = null;
      }
      // 先移除可能残留的 UUID/session 片段（双保险）
      const uuidRegex = /[0-9a-fA-F]{8}-[0-9a-fA-F]{4}-[0-9a-fA-F]{4}-[0-9a-fA-F]{4}-[0-9a-fA-F]{12}/g;
      text = text.replace(uuidRegex, '').replace(/^[0-9a-fA-F-]{36,}\s*/,'');
      // ------- 表格预处理：修复没有换行与使用 '||' 作为行分隔的情况 -------
      text = normalizeMalformedTables(text);
      // Markdown -> HTML (安全净化)
      let html = marked.parse(text); // 已在 setOptions 中启用 gfm & breaks
      // 允许表格相关标签
      html = DOMPurify.sanitize(html, {
        USE_PROFILES: { html: true },
        ALLOWED_TAGS: [ 'a','b','i','em','strong','p','ul','ol','li','code','pre','span','div','br','hr','table','thead','tbody','tr','th','td' ],
        ALLOWED_ATTR: [ 'href','title','class' ]
      });
      target.innerHTML = html;
      if (force) {
        // 最终渲染可再滚动到底
        const box = document.getElementById('chatBox');
        box.scrollTop = box.scrollHeight;
      }
    }

    function normalizeMalformedTables(src) {
      let s = src;
      // 在标题后直接跟着 '|' 的情况插入换行: '##标题|列1|列2' -> '##标题\n|列1|列2'
      s = s.replace(/(#{1,6}[^\n|]*)(?=\|)/g, (m) => m + '\n');
      // 将连续的 '||' 视为行分隔符: '||xxx' -> '\n|xxx'
      s = s.replace(/\|\|(?!\|)/g, '\n|');
      // 若分隔行缺少换行（如 '|头1|头2|---|---|数据'）在 '---' 前插入换行
      s = s.replace(/(\|[^\n]*)(\|[-]{3,}\|)/g, (match, before, sep) => {
        if (!before.endsWith('\n')) {
          return before + '\n' + sep;
        }
        return match;
      });
      return s;
    }

    document.addEventListener('DOMContentLoaded', () => {
      document.getElementById('msgInput').addEventListener('keydown', (e) => {
        if (e.key === 'Enter' && !e.shiftKey) { e.preventDefault(); sendMsg(); }
      });
      document.getElementById('sendBtn').addEventListener('click', sendMsg);
    });
  </script>
  <script src="/js/navbar.js"></script>
  <script>
    // 尽早注入导航栏
    document.addEventListener('DOMContentLoaded', () => {
      // no-op
    });
  </script>
</head>
<body>
  <div th:replace="navbar :: nav"></div>
  <div class="container">
    <h2>AI 助手</h2>
    <div class="hint">提示：你可以直接用自然语言提问，例如“给我推荐 5 本分类为科幻的书”，“id 为 123 的书的详细信息是什么”。</div>
    <div id="chatBox" class="chat-box"></div>
    <div class="input-row">
      <input id="msgInput" placeholder="输入你的问题..." />
      <button id="sendBtn">发送</button>
    </div>
  </div>
</body>
</html>
